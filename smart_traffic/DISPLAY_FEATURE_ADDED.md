# 显示功能添加说明

## 修改日期
2025-10-07

## 修改内容

### 在 `main.c` 中添加了显示当前状态剩余时间的功能

#### 1. 添加的头文件
```c
#include "display.h"
```

#### 2. 添加的全局变量
```c
static unsigned int displayRefreshCounter = 0;  // 显示刷新计数器
```

#### 3. 系统初始化中添加
```c
Display_Init();  // 初始化显示模块
```

#### 4. 主循环中添加显示刷新逻辑
在主循环中添加了完整的显示刷新处理，包括：

- **显示刷新机制**：每100次循环刷新一次显示，避免频繁刷新
- **时间计算逻辑**：根据当前交通灯状态计算南北和东西方向的剩余时间

## 显示时间计算逻辑说明

### 四种交通灯状态的时间计算：

1. **南北绿灯，东西红灯 (STATE_NS_GREEN_EW_RED)**
   - 南北显示：当前剩余绿灯时间
   - 东西显示：当前时间 + 南北黄灯时间

2. **南北黄灯，东西红灯 (STATE_NS_YELLOW_EW_RED)**
   - 南北显示：当前剩余黄灯时间
   - 东西显示：当前剩余时间（即将变绿）

3. **南北红灯，东西绿灯 (STATE_NS_RED_EW_GREEN)**
   - 南北显示：当前时间 + 东西黄灯时间
   - 东西显示：当前剩余绿灯时间

4. **南北红灯，东西黄灯 (STATE_NS_RED_EW_YELLOW)**
   - 南北显示：当前剩余时间（即将变绿）
   - 东西显示：当前剩余黄灯时间

## 功能特点

- ✅ 实时显示南北和东西方向的剩余时间
- ✅ 自动根据交通灯状态计算正确的倒计时
- ✅ 使用动态扫描方式显示，不影响系统性能
- ✅ 与现有的交通灯控制逻辑完全兼容
- ✅ 代码结构清晰，易于维护

## 硬件要求

- 数码管连接到 P0 口（数据端口）
- 位选信号：
  - DISPLAY_SEL_A (P2^6) - 左侧数码管
  - DISPLAY_SEL_B (P2^7) - 中间数码管
  - DISPLAY_SEL_C (P3^0) - 右侧数码管

## 编译说明

确保以下文件在编译工程中：
- `main.c` - 主程序文件（已修改）
- `display.c` - 显示模块实现
- `display.h` - 显示模块头文件
- `config.h` - 配置文件
- `traffic_light.c` - 交通灯控制模块
- `traffic_light.h` - 交通灯控制模块头文件

## 测试建议

1. 上电后观察数码管是否正常显示
2. 检查南北方向倒计时是否与交通灯同步
3. 检查东西方向倒计时是否与交通灯同步
4. 观察状态切换时倒计时是否正确更新
5. 长时间运行测试系统稳定性

## 注意事项

- 显示刷新频率设置为每100次主循环刷新一次，可根据实际需求调整
- 如果显示闪烁，可以减小刷新间隔（减小 displayRefreshCounter 的阈值）
- 如果CPU占用过高，可以增大刷新间隔（增大 displayRefreshCounter 的阈值）
