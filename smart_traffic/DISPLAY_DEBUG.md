# 数码管显示逻辑验证

## 问题分析

### 现象
- 两个数码管显示相同数字
- 一个方向红灯6秒，一个方向绿灯3秒，但显示不对应

### 原因
时间计算逻辑正确，但可能是**显示顺序**或**数码管接线**问题。

---

## 正确的显示逻辑

### 配置（config.h）
```c
#define GREEN_LIGHT_TIME    3    // 绿灯3秒
#define YELLOW_LIGHT_TIME   3    // 黄灯3秒
```

### 状态机流程

```
状态0: 南北绿灯(3s) | 东西红灯(6s)
       ┌─────────────┬─────────────┐
时间   │  南北显示   │  东西显示   │
       ├─────────────┼─────────────┤
  0s   │      3      │      6      │ ← 绿灯剩余3s，红灯需等6s(3绿+3黄)
  1s   │      2      │      5      │
  2s   │      1      │      4      │
       └─────────────┴─────────────┘
              ↓
状态1: 南北黄灯(3s) | 东西红灯(3s)
       ┌─────────────┬─────────────┐
  0s   │      3      │      3      │ ← 黄灯剩余3s，红灯剩余3s
  1s   │      2      │      2      │
  2s   │      1      │      1      │
       └─────────────┴─────────────┘
              ↓
状态2: 南北红灯(6s) | 东西绿灯(3s)
       ┌─────────────┬─────────────┐
  0s   │      6      │      3      │ ← 红灯需等6s(3绿+3黄)，绿灯剩余3s
  1s   │      5      │      2      │
  2s   │      4      │      1      │
       └─────────────┴─────────────┘
              ↓
状态3: 南北红灯(3s) | 东西黄灯(3s)
       ┌─────────────┬─────────────┐
  0s   │      3      │      3      │ ← 红灯剩余3s，黄灯剩余3s
  1s   │      2      │      2      │
  2s   │      1      │      1      │
       └─────────────┴─────────────┘
              ↓
       循环回状态0
```

---

## 验证方法

### 方法1：观察状态0（南北绿灯）

**交通灯状态**：
- P2.2（南北绿灯）= 亮 ✅
- P2.3（东西红灯）= 亮 ✅

**数码管应显示**：
- 左边数码管（南北）：3 → 2 → 1
- 右边数码管（东西）：6 → 5 → 4

**如果显示相同**：
- 检查数码管接线
- 检查 74HC139 的 Y0 和 Y1 输出

### 方法2：观察状态2（东西绿灯）

**交通灯状态**：
- P2.0（南北红灯）= 亮 ✅
- P2.5（东西绿灯）= 亮 ✅

**数码管应显示**：
- 左边数码管（南北）：6 → 5 → 4
- 右边数码管（东西）：3 → 2 → 1

---

## 诊断步骤

### 步骤1：确认数码管位置

在 `System_Init()` 中添加测试代码：

```c
// 测试：左边显示1，右边显示2
Display_ShowTime(1, 2);
Delay_ms(3000);

// 测试：左边显示3，右边显示4
Display_ShowTime(3, 4);
Delay_ms(3000);
```

**预期结果**：
- 左边数码管显示 1，然后 3
- 右边数码管显示 2，然后 4

**如果两个都显示相同数字**：
→ 问题在 `Display_ShowTime()` 函数或硬件接线

---

### 步骤2：检查 Display_ShowTime() 实现

查看 `display.c`：

```c
void Display_ShowTime(unsigned char nsTime, unsigned char ewTime)
{
    // 显示第0位：nsTime（南北）
    DISPLAY_SEL_A = 0;
    DISPLAY_SEL_B = 0;
    DISPLAY_DATA_PORT = segmentTable[nsTime];  // ← 检查这里
    // 延时...
    
    // 显示第1位：ewTime（东西）
    DISPLAY_SEL_A = 1;
    DISPLAY_SEL_B = 0;
    DISPLAY_DATA_PORT = segmentTable[ewTime];  // ← 检查这里
    // 延时...
}
```

**确认**：
- 是否正确使用 `nsTime` 和 `ewTime`（不是都用同一个变量）
- 地址切换是否正确（BA: 00 和 01）

---

### 步骤3：检查硬件连接

#### 74HC139 连接

```
AT89C51          74HC139          数码管
────────────────────────────────────────────
P2.6 (A)    →   A1 (pin2)
P2.7 (B)    →   B1 (pin3)        (接GND或悬空)
                E1 (pin1)    →   GND
                1Y0 (pin4)   →   数码管0 COM (左边)
                1Y1 (pin5)   →   数码管1 COM (右边)
```

**验证**：
- 用万用表测量 1Y0 和 1Y1 是否交替变化
- 当 P2.6=0 时，1Y0 应该为低电平
- 当 P2.6=1 时，1Y1 应该为低电平

---

### 步骤4：添加调试输出

修改 `main.c`，在主循环中添加状态指示：

```c
// 在 switch 语句前
DEBUG_STATE_PIN = tempState & 0x01;  // 用LED显示状态低位

// 在 switch 语句后
if (nsTime != ewTime) {
    DEBUG_1S_PIN = 1;  // 时间不同时点亮
} else {
    DEBUG_1S_PIN = 0;  // 时间相同时熄灭
}
```

**观察**：
- `DEBUG_1S_PIN` 在状态0和状态2时应该亮（时间不同）
- `DEBUG_1S_PIN` 在状态1和状态3时应该灭（时间相同）

---

## 可能的问题

### 问题1：display.c 中用错变量

**错误代码**：
```c
DISPLAY_DATA_PORT = segmentTable[nsTime];  // 第0位
// ...
DISPLAY_DATA_PORT = segmentTable[nsTime];  // 第1位 ← 应该是ewTime！
```

**修正**：
```c
DISPLAY_DATA_PORT = segmentTable[nsTime];  // 第0位
// ...
DISPLAY_DATA_PORT = segmentTable[ewTime];  // 第1位 ✅
```

---

### 问题2：数码管物理位置反了

如果硬件连接反了：
- 74HC139 的 Y0 接到了右边数码管
- 74HC139 的 Y1 接到了左边数码管

**临时解决**：在代码中交换显示
```c
Display_ShowTime(ewTime, nsTime);  // 交换参数顺序
```

**永久解决**：修改硬件接线

---

### 问题3：两个数码管接在一起

如果 Y0 和 Y1 都接到了同一个数码管：
- 两个数码管会显示相同内容
- 或者只有一个数码管工作

**解决**：检查并修正硬件接线

---

## 快速测试代码

在 `System_Init()` 最后，Timer0_Init() 之前添加：

```c
// ==========================================
// 【调试】数码管显示测试
// ==========================================
unsigned char test_i;

// 测试1：显示 "12" 持续3秒
for(test_i = 0; test_i < 150; test_i++) {
    Display_ShowTime(1, 2);
}
Delay_ms(1000);

// 测试2：显示 "34" 持续3秒
for(test_i = 0; test_i < 150; test_i++) {
    Display_ShowTime(3, 4);
}
Delay_ms(1000);

// 测试3：显示 "56" 持续3秒
for(test_i = 0; test_i < 150; test_i++) {
    Display_ShowTime(5, 6);
}
Delay_ms(1000);

// 如果上面都显示相同数字（11、33、55），说明：
// 1. Display_ShowTime() 函数有问题，或
// 2. 硬件接线有问题
```

---

## 总结

**检查清单**：
- [ ] `display.c` 中是否正确使用 `nsTime` 和 `ewTime`
- [ ] 74HC139 的 Y0 和 Y1 是否分别连接到两个数码管
- [ ] P2.6 是否正确连接到 74HC139 的 A1
- [ ] 数码管的物理位置是否对应代码中的南北/东西
- [ ] 使用测试代码验证 `Display_ShowTime(1, 2)` 是否显示不同数字

**重新编译测试，并告诉我测试结果！** 🔍
